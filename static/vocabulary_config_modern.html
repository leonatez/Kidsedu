<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Configuration</title>
    <link rel="stylesheet" href="/static/modern_design.css">
</head>
<body>
    <!-- Floating elements -->
    <div class="floating-element" style="top: 15%; left: 8%; animation-delay: 0s;">⚙️</div>
    <div class="floating-element" style="top: 25%; right: 12%; animation-delay: 1s;">📷</div>
    <div class="floating-element" style="bottom: 25%; left: 15%; animation-delay: 2s;">💾</div>
    <div class="floating-element" style="bottom: 35%; right: 8%; animation-delay: 3s;">✏️</div>

    <div class="modern-container">
        <!-- Navigation -->
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
            <a href="/" class="modern-btn" style="background: #F7FAFC; color: #4A5568; padding: 0.5rem 1rem;">
                <span>←</span>
            </a>
            <h1 style="margin: 0; font-size: 1.5rem; color: #2D3748;">Vocabulary Configuration</h1>
        </div>

        <!-- Quick Actions -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <a href="/vocabulary" class="modern-btn modern-btn-primary">
                <span>🎮</span>
                <span>Play Game</span>
            </a>
            <a href="/" class="modern-btn" style="background: #F7FAFC; color: #4A5568;">
                <span>🏠</span>
                <span>Home</span>
            </a>
        </div>

        <!-- Upload Section -->
        <div class="modern-card animate-slide-in" style="margin-bottom: 2rem;">
            <div class="modern-card-header">
                <div class="modern-card-icon" style="background: var(--gradient-teal);">
                    <span>📸</span>
                </div>
                <div>
                    <h3 class="modern-card-title">Upload New Images</h3>
                    <p class="modern-card-subtitle">Add pictures for your vocabulary game</p>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, rgba(38, 198, 218, 0.1) 0%, rgba(79, 195, 247, 0.1) 100%); padding: 1.5rem; border-radius: var(--radius-lg); margin: 1.5rem 0;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <span style="font-size: 1.25rem;">🔧</span>
                    <strong style="color: var(--accent-teal);">Auto-Optimization</strong>
                </div>
                <p style="margin: 0; color: #4A5568; font-size: 0.875rem; line-height: 1.5;">
                    Images will be automatically resized to 30% of original size to save storage space and improve loading speed.
                </p>
            </div>
            
            <div style="text-align: center; margin: 2rem 0;">
                <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
                <label for="image-upload" class="modern-btn modern-btn-teal" style="cursor: pointer;">
                    <span>📷</span>
                    <span>Choose Images</span>
                </label>
            </div>
            
            <div id="upload-status" style="display: none; text-align: center; margin-top: 1rem; font-weight: 600; color: var(--accent-teal);">
                Processing images...
            </div>
            
            <div id="upload-progress" style="display: none; margin-top: 1rem;">
                <div class="modern-progress">
                    <div id="progress-bar" style="background: var(--gradient-teal); height: 8px; border-radius: var(--radius-xl); width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progress-text" style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem; color: #718096;"></div>
            </div>
        </div>

        <!-- Bulk Text Assignment Section -->
        <div id="bulk-text-section" class="modern-card animate-slide-in" style="display: none; margin-bottom: 2rem;">
            <div class="modern-card-header">
                <div class="modern-card-icon" style="background: var(--gradient-purple);">
                    <span>📝</span>
                </div>
                <div>
                    <h3 class="modern-card-title">Bulk Text Assignment</h3>
                    <p class="modern-card-subtitle">Type all vocabularies at once (one per line) with category</p>
                </div>
            </div>
            
            <div style="margin: 1.5rem 0;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #4A5568;">Category:</label>
                <input type="text" id="bulk-category" placeholder="Enter category (e.g., animals, fruits, colors)" 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); font-size: 0.9rem; margin-bottom: 1rem;"
                       value="default">
            </div>
            
            <div style="margin: 1.5rem 0;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #4A5568;">Vocabularies (one per line):</label>
                <textarea id="bulk-vocabularies" placeholder="Enter vocabulary words, one per line&#10;Example:&#10;cat&#10;dog&#10;bird" 
                          style="width: 100%; height: 150px; padding: 0.75rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); font-family: monospace; resize: vertical; font-size: 0.9rem;"
                          oninput="checkBulkTextReady()"></textarea>
                <div id="bulk-count" style="text-align: right; margin-top: 0.5rem; font-size: 0.875rem; color: #718096;"></div>
            </div>
            
            <button id="bulk-text-btn" class="modern-btn modern-btn-purple" onclick="bulkAssignText()" disabled style="width: 100%;">
                <span>🚀</span>
                <span>Assign All with Category</span>
            </button>
        </div>

        <!-- Individual Assignment Section -->
        <div id="bulk-assignment-section" class="modern-card animate-slide-in" style="display: none; margin-bottom: 2rem;">
            <div class="modern-card-header">
                <div class="modern-card-icon" style="background: var(--gradient-success);">
                    <span>⚡</span>
                </div>
                <div>
                    <h3 class="modern-card-title">Quick Assignment</h3>
                    <p class="modern-card-subtitle">Type vocabularies for each image individually</p>
                </div>
            </div>
            
            <div id="bulk-assignment-grid" class="modern-grid modern-grid-4" style="gap: 1rem; margin: 1.5rem 0;">
                <!-- Dynamic content will be inserted here -->
            </div>
            
            <button id="bulk-assign-btn" class="modern-btn modern-btn-success" onclick="bulkAssignVocabularies()" disabled style="width: 100%;">
                <span>💫</span>
                <span>Assign All Vocabularies</span>
            </button>
        </div>

        <!-- Individual Assignment Section -->
        <div id="items-container">
            <div style="text-align: center; padding: 3rem; color: #718096;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">📂</div>
                <h3 style="margin: 0 0 0.5rem 0; color: #4A5568;">Loading vocabulary items...</h3>
                <div class="modern-progress" style="width: 200px; margin: 1rem auto;">
                    <div class="modern-progress-fill" style="width: 100%; animation: pulse 2s infinite;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let vocabularyItems = [];

        // Load vocabulary items on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadVocabularyItems();
        });

        // Function to resize images to 30% of original size
        function resizeImage(file, scale = 0.3, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    const newWidth = Math.floor(img.width * scale);
                    const newHeight = Math.floor(img.height * scale);
                    
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    canvas.toBlob((blob) => {
                        const resizedFile = new File([blob], file.name, {
                            type: file.type,
                            lastModified: Date.now()
                        });
                        resolve(resizedFile);
                    }, file.type, quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Handle image upload
        document.getElementById('image-upload').addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            const uploadStatus = document.getElementById('upload-status');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            uploadStatus.style.display = 'block';
            uploadProgress.style.display = 'block';

            try {
                const totalFiles = files.length;
                let processedFiles = 0;
                let totalOriginalSize = 0;
                let totalResizedSize = 0;

                for (let file of files) {
                    const progressPercent = Math.round((processedFiles / totalFiles) * 100);
                    progressBar.style.width = progressPercent + '%';
                    progressText.textContent = `Processing ${processedFiles + 1} of ${totalFiles} images`;
                    
                    uploadStatus.textContent = `🔄 Resizing "${file.name}" (30% size reduction)...`;
                    
                    totalOriginalSize += file.size;
                    const resizedFile = await resizeImage(file);
                    totalResizedSize += resizedFile.size;
                    
                    const originalSizeKB = Math.round(file.size / 1024);
                    const resizedSizeKB = Math.round(resizedFile.size / 1024);
                    const reductionPercent = Math.round((1 - resizedFile.size / file.size) * 100);
                    console.log(`📸 ${file.name}: ${originalSizeKB}KB → ${resizedSizeKB}KB (${reductionPercent}% smaller)`);
                    
                    uploadStatus.textContent = `📤 Uploading "${file.name}"...`;
                    
                    const formData = new FormData();
                    formData.append('file', resizedFile);

                    const response = await fetch('/vocabulary/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Upload failed for ${file.name}`);
                    }
                    
                    processedFiles++;
                }

                progressBar.style.width = '100%';
                const totalReductionPercent = Math.round((1 - totalResizedSize / totalOriginalSize) * 100);
                const totalSavedKB = Math.round((totalOriginalSize - totalResizedSize) / 1024);
                
                uploadStatus.textContent = `✅ Success! Saved ${totalSavedKB}KB (${totalReductionPercent}% smaller)`;
                progressText.textContent = `All ${totalFiles} images uploaded successfully!`;
                
                await loadVocabularyItems();
                
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                    uploadProgress.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
                
                event.target.value = '';
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.textContent = `❌ Upload failed: ${error.message}`;
                uploadStatus.style.color = '#E74C3C';
                progressText.textContent = 'Please try again with different images.';
                
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 3000);
            }
        });

        async function loadVocabularyItems() {
            try {
                const response = await fetch('/vocabulary/items');
                if (!response.ok) throw new Error('Failed to load items');

                const data = await response.json();
                vocabularyItems = data.items;
                renderVocabularyItems();
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('items-container').innerHTML = `
                    <div class="modern-card" style="text-align: center; color: #E74C3C;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                        <h3 style="margin: 0 0 1rem 0;">Error Loading Items</h3>
                        <p style="margin: 0; color: #718096;">Make sure Supabase is properly configured.</p>
                    </div>
                `;
            }
        }

        function renderVocabularyItems() {
            const container = document.getElementById('items-container');
            
            if (vocabularyItems.length === 0) {
                container.innerHTML = `
                    <div class="modern-card" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
                        <h3 style="margin: 0 0 1rem 0; color: #4A5568;">No Images Yet</h3>
                        <p style="margin: 0; color: #718096;">Upload some images to get started!</p>
                    </div>
                `;
                document.getElementById('bulk-assignment-section').style.display = 'none';
                document.getElementById('bulk-text-section').style.display = 'none';
                return;
            }
            
            // Show bulk text assignment when there are items
            document.getElementById('bulk-text-section').style.display = 'block';
            checkBulkTextReady();

            const unassignedItems = vocabularyItems.filter(item => !item.vocabulary);
            if (unassignedItems.length > 0) {
                renderBulkAssignment(unassignedItems);
                document.getElementById('bulk-assignment-section').style.display = 'block';
            } else {
                document.getElementById('bulk-assignment-section').style.display = 'none';
            }

            const itemsHtml = vocabularyItems.map(item => `
                <div class="modern-card" style="margin-bottom: 1.5rem;">
                    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <span class="status-badge ${item.vocabulary ? 'status-assigned' : 'status-pending'}">
                            ${item.vocabulary ? '✅ Assigned' : '⏳ Pending'}
                        </span>
                        <span style="font-size: 0.8rem; color: #718096; background: #F7FAFC; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm);">
                            📂 ${item.category || 'default'}
                        </span>
                    </div>
                    <img src="${item.image_url}" alt="Vocabulary item" 
                         style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius-base); margin-bottom: 1rem;" 
                         loading="lazy">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; margin-bottom: 1rem;">
                        <input 
                            type="text" 
                            placeholder="Enter vocabulary word..." 
                            value="${item.vocabulary || ''}"
                            data-item-id="${item.id}"
                            style="padding: 0.75rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); font-size: 1rem; transition: border-color 0.3s ease;"
                            onfocus="this.style.borderColor = 'var(--primary-blue)'; this.style.boxShadow = '0 0 0 3px rgba(74, 108, 247, 0.1)'"
                            onblur="this.style.borderColor = '#E2E8F0'; this.style.boxShadow = 'none'"
                            oninput="updateSaveButton('${item.id}')"
                        >
                        <input 
                            type="text" 
                            placeholder="Category" 
                            value="${item.category || 'default'}"
                            data-item-id="${item.id}"
                            data-field="category"
                            style="width: 120px; padding: 0.75rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); font-size: 0.9rem; transition: border-color 0.3s ease;"
                            onfocus="this.style.borderColor = 'var(--primary-blue)'; this.style.boxShadow = '0 0 0 3px rgba(74, 108, 247, 0.1)'"
                            onblur="this.style.borderColor = '#E2E8F0'; this.style.boxShadow = 'none'"
                            oninput="updateSaveButton('${item.id}')"
                        >
                    </div>
                    <button 
                        class="modern-btn modern-btn-primary" 
                        onclick="saveVocabulary('${item.id}')"
                        style="width: 100%;"
                        ${!item.vocabulary ? 'disabled' : ''}
                    >
                        <span>💾</span>
                        <span>Save Vocabulary</span>
                    </button>
                </div>
            `).join('');

            container.innerHTML = `<div class="modern-grid modern-grid-3">${itemsHtml}</div>`;
        }

        function renderBulkAssignment(unassignedItems) {
            const grid = document.getElementById('bulk-assignment-grid');
            
            const gridHtml = unassignedItems.map(item => `
                <div style="background: white; border-radius: var(--radius-base); padding: 1rem; box-shadow: var(--shadow-sm); text-align: center;">
                    <img src="${item.image_url}" alt="Unassigned item" 
                         style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-base); margin-bottom: 0.5rem;" 
                         loading="lazy">
                    <input 
                        type="text" 
                        placeholder="Word..." 
                        data-item-id="${item.id}"
                        style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: var(--radius-sm); text-align: center; font-size: 0.875rem; margin-top: 0.5rem;"
                        oninput="checkBulkAssignmentReady()"
                    >
                </div>
            `).join('');

            grid.innerHTML = gridHtml;
            checkBulkAssignmentReady();
        }

        function checkBulkAssignmentReady() {
            const inputs = document.querySelectorAll('#bulk-assignment-grid input');
            const allFilled = Array.from(inputs).every(input => input.value.trim() !== '');
            document.getElementById('bulk-assign-btn').disabled = !allFilled;
        }

        async function bulkAssignVocabularies() {
            const inputs = document.querySelectorAll('#bulk-assignment-grid input');
            const bulkBtn = document.getElementById('bulk-assign-btn');
            const originalText = bulkBtn.innerHTML;
            
            bulkBtn.innerHTML = '<span>⏳</span><span>Assigning...</span>';
            bulkBtn.disabled = true;

            try {
                const assignments = [];
                inputs.forEach(input => {
                    const itemId = input.getAttribute('data-item-id');
                    const vocabulary = input.value.trim();
                    if (vocabulary) {
                        assignments.push({ itemId, vocabulary });
                    }
                });

                const promises = assignments.map(async ({ itemId, vocabulary }) => {
                    const formData = new FormData();
                    formData.append('vocabulary', vocabulary);
                    formData.append('category', 'default'); // Individual assignments get default category
                    
                    const response = await fetch(`/vocabulary/update/${itemId}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to save vocabulary for item ${itemId}`);
                    }
                    
                    return response.json();
                });

                await Promise.all(promises);

                assignments.forEach(({ itemId, vocabulary }) => {
                    const item = vocabularyItems.find(i => i.id === itemId);
                    if (item) {
                        item.vocabulary = vocabulary;
                    }
                });

                renderVocabularyItems();
                showToast(`✅ Successfully assigned ${assignments.length} vocabularies!`, 'success');
            } catch (error) {
                console.error('Bulk assignment error:', error);
                bulkBtn.innerHTML = originalText;
                bulkBtn.disabled = false;
                showToast('❌ Failed to assign some vocabularies. Please try again.', 'error');
            }
        }

        function checkBulkTextReady() {
            const textarea = document.getElementById('bulk-vocabularies');
            const lines = textarea.value.trim().split('\n').filter(line => line.trim() !== '');
            const countDiv = document.getElementById('bulk-count');
            const bulkBtn = document.getElementById('bulk-text-btn');
            
            countDiv.textContent = `${lines.length} vocabularies`;
            bulkBtn.disabled = lines.length === 0 || lines.length !== vocabularyItems.length;
            
            if (lines.length > 0 && lines.length !== vocabularyItems.length) {
                countDiv.innerHTML = `${lines.length} vocabularies <span style="color: #E53E3E;">(need ${vocabularyItems.length})</span>`;
            }
        }

        async function bulkAssignText() {
            const textarea = document.getElementById('bulk-vocabularies');
            const categoryInput = document.getElementById('bulk-category');
            const bulkBtn = document.getElementById('bulk-text-btn');
            const originalText = bulkBtn.innerHTML;
            
            const vocabularies = textarea.value.trim();
            const category = categoryInput.value.trim() || 'default';
            
            if (!vocabularies) {
                showToast('Please enter vocabulary words!', 'warning');
                return;
            }
            
            bulkBtn.innerHTML = '<span>⏳</span><span>Assigning...</span>';
            bulkBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('vocabularies', vocabularies);
                formData.append('category', category);
                
                const response = await fetch('/vocabulary/bulk_update', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update vocabularies');
                }
                
                const result = await response.json();
                
                // Update local vocabulary items
                await loadVocabularyItems();
                
                showToast(`✅ Successfully assigned ${result.updated_count} vocabularies to category "${category}"!`, 'success');
                
                // Clear form
                textarea.value = '';
                categoryInput.value = 'default';
                checkBulkTextReady();
                
            } catch (error) {
                console.error('Bulk text assignment error:', error);
                showToast(`❌ ${error.message}`, 'error');
            } finally {
                bulkBtn.innerHTML = originalText;
                bulkBtn.disabled = false;
            }
        }

        function updateSaveButton(itemId) {
            const vocabInput = document.querySelector(`input[data-item-id='${itemId}']:not([data-field])`);
            const saveBtn = document.querySelector(`button[onclick="saveVocabulary('${itemId}')"]`);
            
            if (vocabInput && saveBtn) {
                saveBtn.disabled = !vocabInput.value.trim();
            }
        }

        async function saveVocabulary(itemId) {
            const vocabInput = document.querySelector(`input[data-item-id='${itemId}']:not([data-field])`);
            const categoryInput = document.querySelector(`input[data-item-id='${itemId}'][data-field='category']`);
            const vocabulary = vocabInput.value.trim();
            const category = categoryInput.value.trim() || 'default';
            
            if (!vocabulary) {
                showToast('Please enter a vocabulary word!', 'warning');
                return;
            }

            const saveBtn = document.querySelector(`button[onclick="saveVocabulary('${itemId}')"]`);
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span>⏳</span><span>Saving...</span>';
            saveBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('vocabulary', vocabulary);
                formData.append('category', category);

                const response = await fetch(`/vocabulary/update/${itemId}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Save failed');

                const item = vocabularyItems.find(i => i.id === itemId);
                if (item) {
                    item.vocabulary = vocabulary;
                    item.category = category;
                }

                renderVocabularyItems();
                showToast('✅ Vocabulary saved successfully!', 'success');
            } catch (error) {
                console.error('Save error:', error);
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                showToast('❌ Failed to save vocabulary. Please try again.', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                info: 'var(--gradient-blue)',
                success: 'var(--gradient-success)',
                warning: 'var(--gradient-orange)',
                error: 'var(--gradient-orange)'
            };
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                font-weight: 600;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>