<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numbers - Math Game</title>
    <link rel="stylesheet" href="/static/modern_design.css">
</head>
<body>
    <!-- Floating elements -->
    <div class="floating-element" style="top: 15%; left: 8%; animation-delay: 0s;">‚ûï</div>
    <div class="floating-element" style="top: 25%; right: 12%; animation-delay: 1s;">‚ûñ</div>
    <div class="floating-element" style="bottom: 25%; left: 15%; animation-delay: 2s;">‚úñÔ∏è</div>
    <div class="floating-element" style="bottom: 35%; right: 8%; animation-delay: 3s;">üî¢</div>

    <div class="modern-container">
        <!-- Navigation -->
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
            <a href="/" class="modern-btn" style="background: #F7FAFC; color: #4A5568; padding: 0.5rem 1rem;">
                <span>‚Üê</span>
            </a>
            <h1 style="margin: 0; font-size: 1.5rem; color: #2D3748;">Numbers</h1>
        </div>

        <!-- Setup Section -->
        <div id="setup-section" class="modern-card animate-slide-in">
            <div class="modern-card-header">
                <div class="modern-card-icon" style="background: var(--gradient-blue);">
                    <span>üßÆ</span>
                </div>
                <div>
                    <h3 class="modern-card-title">Math Challenge</h3>
                    <p class="modern-card-subtitle">Choose your difficulty level</p>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, rgba(74, 108, 247, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%); padding: 1.5rem; border-radius: var(--radius-lg); margin: 1.5rem 0;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-blue);">üéØ How to Play:</h4>
                <ul style="margin: 0; padding-left: 1.5rem; color: #4A5568; line-height: 1.6;">
                    <li>Solve 10 arithmetic problems</li>
                    <li>Choose from multiple choice answers</li>
                    <li>Get instant feedback and score</li>
                    <li>Earn achievements for great performance!</li>
                </ul>
            </div>

            <div style="margin: 1.5rem 0;">
                <label for="operations" style="display: block; font-weight: 600; color: #2D3748; margin-bottom: 0.5rem;">
                    üßÆ Operations to practice:
                </label>
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <input type="radio" id="basic-ops" name="operations" value="basic" checked style="display: none;">
                        <label for="basic-ops" class="operation-option" style="display: block; padding: 1rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--gradient-blue); color: white; border-color: var(--primary-blue);">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚ûï‚ûñ</div>
                            <div style="font-size: 0.875rem; font-weight: 600;">Basic</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">Add & Subtract</div>
                        </label>
                    </div>
                    <div style="flex: 1;">
                        <input type="radio" id="all-ops" name="operations" value="all" style="display: none;">
                        <label for="all-ops" class="operation-option" style="display: block; padding: 1rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); text-align: center; cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚ûï‚ûñ‚úñÔ∏è‚ûó</div>
                            <div style="font-size: 0.875rem; font-weight: 600;">All Operations</div>
                            <div style="font-size: 0.75rem; color: #718096;">Add, Subtract, Multiply, Divide</div>
                        </label>
                    </div>
                </div>
            </div>

            <div style="margin: 1.5rem 0;">
                <label for="max-number" style="display: block; font-weight: 600; color: #2D3748; margin-bottom: 0.5rem;">
                    üìä Maximum number for problems:
                </label>
                <input type="number" id="max-number" value="20" min="5" max="100" 
                       style="width: 100%; padding: 1rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); font-size: 1rem; transition: border-color 0.3s ease;">
                <div style="font-size: 0.875rem; color: #718096; margin-top: 0.5rem;">
                    Choose between 5 and 100 for your comfort level
                </div>
            </div>

            <button class="modern-btn modern-btn-primary animate-pulse" onclick="startGame()" style="width: 100%; font-size: 1.125rem; padding: 1rem;">
                <span>üöÄ</span>
                <span>Start Math Challenge</span>
            </button>
        </div>

        <!-- Game Section -->
        <div id="game-section" class="hidden">
            <!-- Progress Header -->
            <div class="modern-card" style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <div id="question-counter" style="font-size: 0.875rem; font-weight: 600; color: var(--primary-blue);">
                            Question 1 of 10
                        </div>
                        <div style="font-size: 0.75rem; color: #718096; margin-top: 0.25rem;">
                            Keep going! You're doing great üí™
                        </div>
                    </div>
                    <div style="background: var(--gradient-blue); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-xl); font-weight: 600; font-size: 0.875rem;">
                        <span id="current-score">0</span>/10
                    </div>
                </div>
                <div class="modern-progress">
                    <div class="modern-progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Question Card -->
            <div id="current-question" class="question-card animate-slide-in">
                <!-- Dynamic content will be inserted here -->
            </div>

            <!-- Submit Button -->
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="modern-btn modern-btn-success" onclick="submitAnswer()" id="submit-btn" disabled style="font-size: 1.125rem; padding: 1rem 2rem;">
                    <span>‚ú®</span>
                    <span>Submit Answer</span>
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <!-- Score Header -->
            <div class="results-card animate-slide-in" style="background: var(--gradient-blue); margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                <div class="results-score" id="final-score">8/10</div>
                <div class="results-message" id="motivation-message">Excellent work! You're amazing at math!</div>
            </div>
            
            <!-- Detailed Results -->
            <div class="modern-card animate-slide-in" style="margin-bottom: 1.5rem;">
                <div class="modern-card-header" style="margin-bottom: 1.5rem;">
                    <div class="modern-card-icon" style="background: var(--gradient-success);">
                        <span>üìã</span>
                    </div>
                    <div>
                        <h3 class="modern-card-title">Detailed Results</h3>
                        <p class="modern-card-subtitle">Review your answers</p>
                    </div>
                </div>
                
                <!-- Results Table Header -->
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; padding: 1rem; background: #F7FAFC; border-radius: var(--radius-base); margin-bottom: 1rem; font-weight: 600; color: #2D3748; font-size: 0.875rem;">
                    <div>Question</div>
                    <div>Your Answer</div>
                    <div>Correct Answer</div>
                </div>
                
                <!-- Results List -->
                <div id="detailed-results" style="max-height: 400px; overflow-y: auto;">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="modern-card animate-slide-in">
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="modern-btn modern-btn-primary" onclick="playAgain()">
                        <span>üîÑ</span>
                        <span>Try Again</span>
                    </button>
                    <a href="/" class="modern-btn" style="background: #F7FAFC; color: #4A5568;">
                        <span>üè†</span>
                        <span>Home</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGame = {
            questions: [],
            currentQuestionIndex: 0,
            userAnswers: [],
            correctAnswers: [],
            score: 0
        };

        // Add input styling
        document.getElementById('max-number').addEventListener('focus', function() {
            this.style.borderColor = 'var(--primary-blue)';
            this.style.boxShadow = '0 0 0 3px rgba(74, 108, 247, 0.1)';
        });

        document.getElementById('max-number').addEventListener('blur', function() {
            this.style.borderColor = '#E2E8F0';
            this.style.boxShadow = 'none';
        });

        // Handle operation selection styling
        document.querySelectorAll('input[name="operations"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.operation-option').forEach(label => {
                    label.style.background = '';
                    label.style.color = '#4A5568';
                    label.style.borderColor = '#E2E8F0';
                });
                
                const selectedLabel = document.querySelector(`label[for="${this.id}"]`);
                selectedLabel.style.background = 'var(--gradient-blue)';
                selectedLabel.style.color = 'white';
                selectedLabel.style.borderColor = 'var(--primary-blue)';
            });
        });

        async function startGame() {
            const maxNumber = parseInt(document.getElementById('max-number').value);
            const operations = document.querySelector('input[name="operations"]:checked').value;
            
            if (maxNumber < 5 || maxNumber > 100) {
                showToast('ü§î Please choose a number between 5 and 100!', 'warning');
                return;
            }

            try {
                const response = await fetch('/math/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        max_number: maxNumber,
                        operations: operations
                    })
                });

                if (!response.ok) throw new Error('Failed to generate questions');

                const data = await response.json();
                currentGame.questions = data.questions;
                currentGame.correctAnswers = data.questions.map(q => q.answer);
                currentGame.currentQuestionIndex = 0;
                currentGame.userAnswers = [];
                currentGame.score = 0;

                // Transition to game
                document.getElementById('setup-section').classList.add('hidden');
                document.getElementById('game-section').classList.remove('hidden');
                document.getElementById('results-section').classList.add('hidden');

                displayCurrentQuestion();
            } catch (error) {
                console.error('Error starting game:', error);
                showToast('üòÖ Oops! Something went wrong. Please try again!', 'error');
            }
        }

        function displayCurrentQuestion() {
            const question = currentGame.questions[currentGame.currentQuestionIndex];
            const questionContainer = document.getElementById('current-question');
            
            // Update progress
            const progress = ((currentGame.currentQuestionIndex + 1) / currentGame.questions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('question-counter').textContent = 
                `Question ${currentGame.currentQuestionIndex + 1} of ${currentGame.questions.length}`;
            document.getElementById('current-score').textContent = currentGame.score;

            questionContainer.innerHTML = `
                <div class="question-number">Question ${currentGame.currentQuestionIndex + 1}</div>
                <div class="question-text">${question.question}</div>
                <div class="options-grid">
                    ${question.options.map((option, index) => `
                        <div class="option-card" onclick="selectOption(${option}, this)">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('submit-btn').disabled = true;
        }

        function selectOption(value, element) {
            document.querySelectorAll('.option-card').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            currentGame.selectedAnswer = value;
            document.getElementById('submit-btn').disabled = false;
        }

        function submitAnswer() {
            if (currentGame.selectedAnswer === undefined) return;

            // Check if correct
            const isCorrect = currentGame.selectedAnswer === currentGame.correctAnswers[currentGame.currentQuestionIndex];
            if (isCorrect) currentGame.score++;

            currentGame.userAnswers.push(currentGame.selectedAnswer);
            currentGame.selectedAnswer = undefined;
            currentGame.currentQuestionIndex++;
            
            if (currentGame.currentQuestionIndex < currentGame.questions.length) {
                displayCurrentQuestion();
            } else {
                showResults();
            }
        }

        async function showResults() {
            try {
                const response = await fetch('/math/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        answers: currentGame.userAnswers,
                        correct_answers: currentGame.correctAnswers
                    })
                });

                if (!response.ok) throw new Error('Failed to check answers');

                const results = await response.json();
                
                document.getElementById('game-section').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');

                document.getElementById('final-score').textContent = 
                    `${results.score}/${results.total}`;
                document.getElementById('motivation-message').textContent = results.message;

                // Populate detailed results
                populateDetailedResults();

                if (results.percentage >= 70) {
                    createConfetti();
                }

            } catch (error) {
                console.error('Error checking answers:', error);
                showToast('üòÖ Oops! Something went wrong checking your answers.', 'error');
            }
        }

        function populateDetailedResults() {
            const detailedResultsContainer = document.getElementById('detailed-results');
            let resultsHTML = '';
            
            currentGame.questions.forEach((question, index) => {
                const userAnswer = currentGame.userAnswers[index] || 'No Answer';
                const correctAnswer = currentGame.correctAnswers[index];
                const isCorrect = userAnswer === correctAnswer;
                
                resultsHTML += `
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; padding: 1rem; border-bottom: 1px solid #E2E8F0; align-items: center;">
                        <!-- Question Column -->
                        <div style="padding: 0 0.5rem;">
                            <div style="font-weight: 600; color: #2D3748; margin-bottom: 0.25rem;">
                                ${question.question}
                            </div>
                        </div>
                        
                        <!-- User Answer Column -->
                        <div style="text-align: center; padding: 0 0.5rem;">
                            <div style="background: ${isCorrect ? '#10B981' : '#EF4444'}; color: white; padding: 0.5rem 1rem; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.875rem; display: inline-block; min-width: 80px;">
                                ${userAnswer}
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: ${isCorrect ? '#10B981' : '#EF4444'};">
                                ${isCorrect ? '‚úÖ Correct' : '‚ùå Wrong'}
                            </div>
                        </div>
                        
                        <!-- Correct Answer Column -->
                        <div style="text-align: center; padding: 0 0.5rem;">
                            <div style="background: #10B981; color: white; padding: 0.5rem 1rem; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.875rem; display: inline-block; min-width: 80px;">
                                ${correctAnswer}
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: #10B981;">
                                ‚úì Answer
                            </div>
                        </div>
                    </div>
                `;
            });
            
            detailedResultsContainer.innerHTML = resultsHTML;
        }

        function playAgain() {
            document.getElementById('setup-section').classList.remove('hidden');
            document.getElementById('game-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            
            currentGame = {
                questions: [],
                currentQuestionIndex: 0,
                userAnswers: [],
                correctAnswers: [],
                score: 0
            };
        }

        function createConfetti() {
            const colors = ['#FF6B35', '#4A6CF7', '#26C6DA', '#2ECC71', '#F39C12', '#9B59B6'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 5000);
                }, i * 100);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                info: 'var(--gradient-blue)',
                success: 'var(--gradient-success)',
                warning: 'var(--gradient-orange)',
                error: 'var(--gradient-orange)'
            };
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                font-weight: 600;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const submitBtn = document.getElementById('submit-btn');
                if (!submitBtn.disabled && !document.getElementById('game-section').classList.contains('hidden')) {
                    submitAnswer();
                }
            }

            if (event.key >= '1' && event.key <= '4') {
                const options = document.querySelectorAll('.option-card');
                const optionIndex = parseInt(event.key) - 1;
                if (options[optionIndex]) {
                    const optionValue = parseInt(options[optionIndex].textContent);
                    selectOption(optionValue, options[optionIndex]);
                }
            }
        });

        // Add CSS for slide animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            .hidden { display: none !important; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>