<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabularies - Learning Game</title>
    <link rel="stylesheet" href="/static/modern_design.css">
</head>
<body>
    <!-- Floating elements -->
    <div class="floating-element" style="top: 15%; left: 8%; animation-delay: 0s;">üìñ</div>
    <div class="floating-element" style="top: 25%; right: 12%; animation-delay: 1s;">üî§</div>
    <div class="floating-element" style="bottom: 25%; left: 15%; animation-delay: 2s;">üí≠</div>
    <div class="floating-element" style="bottom: 35%; right: 8%; animation-delay: 3s;">üìù</div>

    <div class="modern-container">
        <!-- Navigation -->
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
            <a href="/" class="modern-btn" style="background: #F7FAFC; color: #4A5568; padding: 0.5rem 1rem;">
                <span>‚Üê</span>
            </a>
            <h1 style="margin: 0; font-size: 1.5rem; color: #2D3748;">Vocabularies</h1>
        </div>

        <!-- Setup Section -->
        <div id="setup-section" class="modern-card animate-slide-in">
            <div class="modern-card-header">
                <div class="modern-card-icon" style="background: var(--gradient-orange);">
                    <span>Aa</span>
                </div>
                <div>
                    <h3 class="modern-card-title">Vocabulary Challenge</h3>
                    <p class="modern-card-subtitle">Learn words through pictures</p>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 142, 104, 0.1) 100%); padding: 1.5rem; border-radius: var(--radius-lg); margin: 1.5rem 0;">
                <h4 style="margin: 0 0 1rem 0; color: var(--accent-orange);">üéØ How to Play:</h4>
                <ul style="margin: 0; padding-left: 1.5rem; color: #4A5568; line-height: 1.6;">
                    <li>Look at the picture carefully</li>
                    <li>Choose the correct vocabulary word</li>
                    <li>Answer 10 unique questions</li>
                    <li>Build your vocabulary skills!</li>
                </ul>
            </div>

            <div style="margin: 1.5rem 0;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #4A5568;">üìÇ Category:</label>
                <select id="category-select" style="width: 100%; padding: 0.75rem; border: 2px solid #E2E8F0; border-radius: var(--radius-base); font-size: 1rem; background: white;">
                    <option value="all">All Categories</option>
                    <!-- Categories will be loaded dynamically -->
                </select>
                <div id="category-info" style="font-size: 0.875rem; color: #718096; margin-top: 0.5rem;">
                    Loading categories...
                </div>
            </div>

            <button class="modern-btn modern-btn-secondary animate-pulse" onclick="startGame()" style="width: 100%; font-size: 1.125rem; padding: 1rem;">
                <span>üìö</span>
                <span>Start Vocabulary Challenge</span>
            </button>
            
            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #F1F5F9;">
                <h4 style="margin: 0 0 1rem 0; color: #2D3748;">‚öôÔ∏è Need to add vocabulary?</h4>
                <p style="margin: 0 0 1rem 0; color: #718096;">Upload images and assign vocabulary words first!</p>
                <a href="/vocabulary/config" class="modern-btn modern-btn-teal">
                    <span>üîß</span>
                    <span>Configure Vocabulary</span>
                </a>
            </div>
        </div>

        <!-- Game Section -->
        <div id="game-section" class="hidden" style="height: calc(100vh - 100px); display: flex; flex-direction: column;">
            <!-- Compact Progress Header -->
            <div class="modern-card" style="margin-bottom: 1rem; padding: 1rem; flex-shrink: 0;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.75rem;">
                    <div>
                        <div id="question-counter" style="font-size: 0.875rem; font-weight: 600; color: var(--accent-orange);">
                            Question 1 of 10
                        </div>
                        <div style="font-size: 0.75rem; color: #718096; margin-top: 0.25rem;">
                            What word matches this picture? üñºÔ∏è
                        </div>
                    </div>
                    <div style="background: var(--gradient-orange); color: white; padding: 0.4rem 0.8rem; border-radius: var(--radius-xl); font-weight: 600; font-size: 0.875rem;">
                        <span id="current-score">0</span>/10
                    </div>
                </div>
                <div class="modern-progress">
                    <div class="modern-progress-fill" id="progress-fill" style="width: 0%; background: var(--gradient-orange);"></div>
                </div>
            </div>

            <!-- Compact Question Card -->
            <div id="current-question" class="question-card animate-slide-in" style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem; margin-bottom: 1rem;">
                <!-- Dynamic content will be inserted here -->
            </div>

            <!-- Compact Submit Button -->
            <div style="text-align: center; flex-shrink: 0;">
                <button class="modern-btn modern-btn-secondary" onclick="submitAnswer()" id="submit-btn" disabled style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                    <span>‚ú®</span>
                    <span>Submit Answer</span>
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <!-- Score Header -->
            <div class="results-card animate-slide-in" style="background: var(--gradient-orange); margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üèÜ</div>
                <div class="results-score" id="final-score">8/10</div>
                <div class="results-message" id="motivation-message">Excellent work! You're amazing with words!</div>
            </div>

            <!-- Detailed Results -->
            <div class="modern-card animate-slide-in" style="margin-bottom: 1.5rem;">
                <div class="modern-card-header" style="margin-bottom: 1.5rem;">
                    <div class="modern-card-icon" style="background: var(--gradient-blue);">
                        <span>üìã</span>
                    </div>
                    <div>
                        <h3 class="modern-card-title">Detailed Results</h3>
                        <p class="modern-card-subtitle">Review your answers</p>
                    </div>
                </div>

                <!-- Results Table Header -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; padding: 1rem; background: #F8FAFC; border-radius: var(--radius-lg); margin-bottom: 1rem; font-weight: 600; color: #475569; font-size: 0.875rem; text-align: center;">
                    <div>Picture</div>
                    <div>Your Answer</div>
                    <div>Correct Answer</div>
                </div>

                <!-- Results List -->
                <div id="detailed-results" style="max-height: 400px; overflow-y: auto;">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="modern-card animate-slide-in">
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="modern-btn modern-btn-secondary" onclick="playAgain()">
                        <span>üîÑ</span>
                        <span>Try Again</span>
                    </button>
                    <a href="/" class="modern-btn modern-btn-teal">
                        <span>üè†</span>
                        <span>Home</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGame = {
            questions: [],
            currentQuestionIndex: 0,
            userAnswers: [],
            correctAnswers: [],
            score: 0
        };

        // Load categories on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
        });

        async function loadCategories() {
            try {
                const response = await fetch('/vocabulary/categories');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('category-select');
                    const info = document.getElementById('category-info');
                    
                    // Clear existing options except "All Categories"
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // Add category options
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                        select.appendChild(option);
                    });
                    
                    info.textContent = data.categories.length > 0 
                        ? `${data.categories.length} categories available`
                        : 'No categories found';
                } else {
                    document.getElementById('category-info').textContent = 'Could not load categories';
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('category-info').textContent = 'Error loading categories';
            }
        }

        async function startGame() {
            try {
                const selectedCategory = document.getElementById('category-select').value;
                
                const formData = new FormData();
                if (selectedCategory !== 'all') {
                    formData.append('category', selectedCategory);
                }
                
                const response = await fetch('/vocabulary/generate', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to generate questions');
                }

                const data = await response.json();
                currentGame.questions = data.questions;
                currentGame.correctAnswers = data.questions.map(q => q.correct_answer);
                currentGame.currentQuestionIndex = 0;
                currentGame.userAnswers = [];
                currentGame.score = 0;

                // Transition to game
                document.getElementById('setup-section').classList.add('hidden');
                document.getElementById('game-section').classList.remove('hidden');
                document.getElementById('results-section').classList.add('hidden');

                displayCurrentQuestion();
            } catch (error) {
                console.error('Error starting game:', error);
                let errorMessage = 'üòÖ Oops! Something went wrong.';
                
                if (error.message.includes('Not enough vocabulary items')) {
                    errorMessage = 'üìö You need at least 4 vocabulary items to play! Please configure some vocabulary first.';
                } else if (error.message.includes('Supabase not configured')) {
                    errorMessage = '‚öôÔ∏è Supabase is not configured. Please check your environment variables.';
                }
                
                showToast(errorMessage, 'warning');
            }
        }

        function displayCurrentQuestion() {
            const question = currentGame.questions[currentGame.currentQuestionIndex];
            const questionContainer = document.getElementById('current-question');
            
            // Update progress
            const progress = ((currentGame.currentQuestionIndex + 1) / currentGame.questions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('question-counter').textContent = 
                `Question ${currentGame.currentQuestionIndex + 1} of ${currentGame.questions.length}`;
            document.getElementById('current-score').textContent = currentGame.score;

            questionContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <img src="${question.image_url}" alt="Vocabulary question" style="max-width: 200px; max-height: 150px; object-fit: cover; border-radius: var(--radius-lg); box-shadow: var(--shadow-base);" loading="lazy">
                </div>
                <div style="font-size: 1.25rem; font-weight: 600; color: #2D3748; text-align: center; margin-bottom: 1rem;">What is this?</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem;">
                    ${question.options.map((option, index) => `
                        <div class="option-card" onclick="selectOption('${option}', this)" style="padding: 0.75rem; font-size: 0.875rem;">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('submit-btn').disabled = true;
        }

        function selectOption(value, element) {
            document.querySelectorAll('.option-card').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            currentGame.selectedAnswer = value;
            document.getElementById('submit-btn').disabled = false;
        }

        function submitAnswer() {
            if (currentGame.selectedAnswer === undefined) return;

            // Check if correct
            const isCorrect = currentGame.selectedAnswer === currentGame.correctAnswers[currentGame.currentQuestionIndex];
            if (isCorrect) currentGame.score++;

            currentGame.userAnswers.push(currentGame.selectedAnswer);
            currentGame.selectedAnswer = undefined;
            currentGame.currentQuestionIndex++;
            
            if (currentGame.currentQuestionIndex < currentGame.questions.length) {
                displayCurrentQuestion();
            } else {
                showResults();
            }
        }

        async function showResults() {
            try {
                const response = await fetch('/vocabulary/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        answers: currentGame.userAnswers,
                        correct_answers: currentGame.correctAnswers
                    })
                });

                if (!response.ok) throw new Error('Failed to check answers');

                const results = await response.json();
                
                document.getElementById('game-section').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');

                document.getElementById('final-score').textContent = 
                    `${results.score}/${results.total}`;
                document.getElementById('motivation-message').textContent = results.message;

                // Populate detailed results
                populateDetailedResults();

                if (results.percentage >= 70) {
                    createConfetti();
                }

            } catch (error) {
                console.error('Error checking answers:', error);
                showToast('üòÖ Oops! Something went wrong checking your answers.', 'error');
            }
        }

        function populateDetailedResults() {
            const detailedResultsContainer = document.getElementById('detailed-results');
            let resultsHTML = '';

            currentGame.questions.forEach((question, index) => {
                const userAnswer = currentGame.userAnswers[index] || 'No Answer';
                const correctAnswer = currentGame.correctAnswers[index];
                const isCorrect = userAnswer === correctAnswer;
                
                resultsHTML += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; padding: 1rem; border-bottom: 1px solid #E2E8F0; align-items: center;">
                        <!-- Picture Column -->
                        <div style="text-align: center;">
                            <img src="${question.image_url}" alt="Question ${index + 1}" style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                        </div>
                        
                        <!-- User Answer Column -->
                        <div style="text-align: center; padding: 0 0.5rem;">
                            <div style="background: ${isCorrect ? '#10B981' : '#EF4444'}; color: white; padding: 0.5rem 1rem; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.875rem; display: inline-block; min-width: 80px;">
                                ${userAnswer}
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: ${isCorrect ? '#10B981' : '#EF4444'};">
                                ${isCorrect ? '‚úÖ Correct' : '‚ùå Wrong'}
                            </div>
                        </div>
                        
                        <!-- Correct Answer Column -->
                        <div style="text-align: center; padding: 0 0.5rem;">
                            <div style="background: #10B981; color: white; padding: 0.5rem 1rem; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.875rem; display: inline-block; min-width: 80px;">
                                ${correctAnswer}
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: #10B981;">
                                ‚úì Answer
                            </div>
                        </div>
                    </div>
                `;
            });

            detailedResultsContainer.innerHTML = resultsHTML;
        }

        function playAgain() {
            document.getElementById('setup-section').classList.remove('hidden');
            document.getElementById('game-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            
            currentGame = {
                questions: [],
                currentQuestionIndex: 0,
                userAnswers: [],
                correctAnswers: [],
                score: 0
            };
        }

        function createConfetti() {
            const colors = ['#FF6B35', '#4A6CF7', '#26C6DA', '#2ECC71', '#F39C12', '#9B59B6'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 5000);
                }, i * 100);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                info: 'var(--gradient-blue)',
                success: 'var(--gradient-success)',
                warning: 'var(--gradient-orange)',
                error: 'var(--gradient-orange)'
            };
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                font-weight: 600;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const submitBtn = document.getElementById('submit-btn');
                if (!submitBtn.disabled && !document.getElementById('game-section').classList.contains('hidden')) {
                    submitAnswer();
                }
            }

            if (event.key >= '1' && event.key <= '4') {
                const options = document.querySelectorAll('.option-card');
                const optionIndex = parseInt(event.key) - 1;
                if (options[optionIndex]) {
                    const optionValue = options[optionIndex].textContent.trim();
                    selectOption(optionValue, options[optionIndex]);
                }
            }
        });

        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            .hidden { display: none !important; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>